---
title: "fetching all NJ data"
author: "Andrew Martin"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{fetching all NJ data}
  %\VignetteEngine{knitr::rmarkdown}
  \usepackage[utf8]{inputenc}
---

```{r silent1, echo=F, results='hide', message=F}
#libraries and functions etc
require(dplyr)
require(ensurer)
```

## grab everything!

I was going to include this as a function, but it's an (intentionally) unwieldy block of code, so perhaps a vignette is a better home.

If you want to bring down all of the NJ statewide assessment files (NJASK, HSPA, GEPA) from 2004-2014, it's just matter of enumerating all the year/grade pairs, and calling `fetch_nj_assess`.  The pattern of offerings has switched around a few times (read the state [website](http://www.nj.gov/education/schools/achievement/) for more detail), so frankly the most complicated thing that this code does is generate the right list of pairs.

```{r easy_button, warning=FALSE, message=FALSE}
require(njschooldata)

fetch_all_nj <- function() {
  
  #make the df of years and grades to iterate over  
  post2006_years <- c(2006:2014)
  post2006_grades <- c(3:8, 11)
  
  pre2006_years <- c(2004, 2005)
  pre2006_grades <- c(3, 4, 8, 11)

  df <- data.frame(
    year = vector(mode="numeric", length=0),
    grade = vector(mode="numeric", length=0)
  )
  
  for (i in post2006_years) {
    #use R recycling to make df
    int_df <- data.frame(
      year = i,
      grade = post2006_grades
    )
    df <- rbind(df, int_df)
  }
  
  for (j in pre2006_years) {
    #use R recycling to make df
    int_df <- data.frame(
      year = j,
      grade = pre2006_grades
    )
    df <- rbind(df, int_df)
  }

  #sort the df
  df <- df %>% dplyr::arrange(
    desc(year), grade
  )
  
  #to hold the results
  results <- list()
  
  #iterate over the df and get the data
  for (i in 1:nrow(df)) {
    this_row <- df[i, ]
    #be verbose
    row_key <- paste0('nj', this_row$year, 'gr', this_row$grade)
    print(row_key)
    
    #call this grade/year and attach to results list
    results[[row_key]] <-  fetch_nj_assess(this_row$year, this_row$grade)
  }

  return(results)  
}

```

calling this code gives us a list of 71 data frames:
```{r run_it}

all_nj <- fetch_all_nj()

length(all_nj)

names(all_nj)

```

and if you look at, say, position number 4 (`r names(all_nj)[4]`):

```{r examine_one}

all_nj[[4]][1:10, 1:15] %>% as.data.frame()

```

You can see that you have a data frame of NJASK assessment results.

# cleaning the data

```{r}

metadata <- data.frame(
  year = numeric(length(all_nj)), 
  grade = numeric(length(all_nj)), 
  ncol = numeric(length(all_nj))
)

assess_names <- ''
for (i in 1:length(all_nj)) {
  print(i)
  print(names(all_nj)[i])
  #match? 
  print(all(names(all_nj[[i]]) == assess_names))
  #set
  assess_names <- names(all_nj[[i]])
}

njask_2014 <- rbind_list(
  all_nj[[1]], all_nj[[2]], all_nj[[3]], all_nj[[4]], all_nj[[5]], all_nj[[6]]
)


```

